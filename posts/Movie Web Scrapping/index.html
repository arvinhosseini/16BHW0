<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arvin Hosseini">
<meta name="dcterms.date" content="2024-02-03">

<title>myblog - Data Visualization and Databases</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">myblog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data Visualization and Databases</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Tutorials</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Arvin Hosseini </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 3, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="movie-web-scrapping-using-scrapy" class="level1">
<h1>Movie Web Scrapping using scrapy</h1>
<p>Hello! In this blog post I will go over how to create a web scrapper using scrapy. For the purpose of this post, the goal of our web scrapper is to find all actors from a particular movie and output the list the actors along with all other movies or TV shows they have been in. The website we will be webscrapping is www.themoviedb.org, which is a website that holds movie and TV show information.</p>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set Up</h2>
<p>The first step is to include the neccesary packages. When I was creating this webscrapper, I had issues with 403 errors. Therefore, I used a proxy via ScrapeOps to help resolve the errors and successfully scrape the websites.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scrapy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urlencode</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>API_KEY <span class="op">=</span> <span class="st">"816aed8f-f731-424c-b089-7c03af87389e"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_scrapeops_url(url):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> {<span class="st">'api_key'</span>: API_KEY, <span class="st">'url'</span>: url}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    proxy_url <span class="op">=</span> <span class="st">'https://proxy.scrapeops.io/v1/?'</span> <span class="op">+</span> urlencode(payload)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proxy_url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The get_scrapeops_url function will serve as a proxy and we can input a normal url into the function and it allow for us to not get flagged.</p>
</section>
<section id="declaring-class-and-defining-parse-function" class="level2">
<h2 class="anchored" data-anchor-id="declaring-class-and-defining-parse-function">Declaring class and defining parse function</h2>
<p>Now that we have inlcuded everything neccessary, we can start building our Spider class from scrapy. First we need to declare the class and the definite the constructor function <strong>init</strong> which would define the starting url that we are trying to scrape.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TmdbSpider(scrapy.Spider):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">'tmdb_spider'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, subdir<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.start_urls <span class="op">=</span> [get_scrapeops_url(<span class="ss">f"https://www.themoviedb.org/movie/</span><span class="sc">{</span>subdir<span class="sc">}</span><span class="ss">/"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see, the we created the TmbdSpider class and named it ‘tmbd_spider’ and used the proxy to build our constructor. The {subdir} portion of the URL is what movie we are trying to scrape. For example, my favorie moive is Interstellar, so subdir will be defined as 157336-interstellar, since the full URL is https://www.themoviedb.org/movie/157336-interstellar.</p>
<p>Next, we need to define our parse function, which will take our spider web scrapper to the cast and crew section of our movie.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse(<span class="va">self</span>, response):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Navigate to the Full Cast &amp; Crew page</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>   full_credits_url <span class="op">=</span> response.url <span class="op">+</span> <span class="st">'/cast/'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>   <span class="cf">yield</span> scrapy.Request(full_credits_url , callback<span class="op">=</span><span class="va">self</span>.parse_full_credits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On themoviedb webstite, once we are on our movie’s website (i.e.&nbsp;https://www.themoviedb.org/movie/157336-interstellar), if we click on the Full Cast and Crew button we are redirected to the cast page with the following URL: https://www.themoviedb.org/movie/157336-interstellar/cast. As we can see, the only difference between this URL and the previous is the added /cast at the end. Therefore, we will yeid the same URL as before and make sure to add the /cast/ the URL, so that we are now navigated to the Full Cast and Crew page.</p>
</section>
<section id="the-parse_full_credits-function" class="level2">
<h2 class="anchored" data-anchor-id="the-parse_full_credits-function">The parse_full_credits function</h2>
<p>Next we will implement the parse_full_credits function of our spider class. The goal of this function will be to retrieve all the actor links for the actors in our movie. On the movie database website, each actor has their own page which lists information about thier bio, acting credits, and more. For example, the lead actor in Interstellar has the following page on TMDB: https://www.themoviedb.org/person/10297-matthew-mcconaughey. Here is the implementation of the parse_full_credits method:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_full_credits(<span class="va">self</span>, response):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract actor links and yield requests for each actor's page</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        actor_links <span class="op">=</span> response.css(<span class="st">'div.info &gt; p &gt; a::attr(href)'</span>).getall()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> actor_link <span class="kw">in</span> actor_links:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> scrapy.Request(get_scrapeops_url(<span class="st">"https://www.themoviedb.org"</span> <span class="op">+</span> actor_link), callback<span class="op">=</span><span class="va">self</span>.parse_actor_page)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we look at few of the pages on TMDB website, we notice that every acting page had the same starting URL: https://www.themoviedb.org. Therefore, we need to find what follows this URL, which we call actor_link, then add it to the starting URL, which will give the full URL for the acting page.</p>
<p>By going on the initial movie’s website and using the developer’s tools, I was able to find that link to every actor in the movie was listed in there. By following the path from div.info to p to a::attr(href), we are able to extract the second half the URL that we need.</p>
<p>Thus, we can yield the full URL for each actor in the movie.</p>
</section>
<section id="the-parse_actor_page-function" class="level2">
<h2 class="anchored" data-anchor-id="the-parse_actor_page-function">The parse_actor_page function</h2>
<p>Finally, we need to implement our final function, the parse_actor_page function. The goal of this function to go through each of the actor’s page and extract all the movies and TV shows that they have appeared in. We will then yield the name of the actor and the list of movies and TV shows.</p>
<p>Let’s first go over how to extract the name of the actor. The beggining of the parse_actor_page looks like this:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_actor_page(<span class="va">self</span>, response):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract actor name and movies/TV shows they have worked in</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        actor_name <span class="op">=</span> response.css(<span class="st">'head &gt; title::text'</span>).get()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract only the part before the hyphen</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        actor_name <span class="op">=</span> actor_name.split(<span class="st">'—'</span>)[<span class="dv">0</span>].strip()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the developer’s tools again, I was able to see that every actor’s page had their name listed in the source code under, first under the head section, then under the title section. Therefore, the selector response.css(‘head &gt; title::text’).get(), would retrieve the title of the webpage. However, this response includes the title of the website. So for example, for Matthew McConaughey, the selector would give the following response: “Matthew McConaughey — The Movie Database (TMDB)”. Therefore we need to cut off everything from the long dash,‘—’, and onwards. By using the split function with ‘—’ and selecting the first half the split, [0], we are able to isolate the name of the actor. We will store this value in the variable actor_name.</p>
<p>Next, we need to implement the second half the function that will extract the movie and TV names for every actor. Here is the full implementation of the parse_actor_page function, with the second half of the function:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_actor_page(<span class="va">self</span>, response):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract actor name and movies/TV shows they have worked in</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        actor_name <span class="op">=</span> response.css(<span class="st">'head &gt; title::text'</span>).get()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract only the part before the hyphen</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        actor_name <span class="op">=</span> actor_name.split(<span class="st">'—'</span>)[<span class="dv">0</span>].strip()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Find the index of 'Acting' in the list of credits</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        acting_index <span class="op">=</span> response.xpath(<span class="st">'//div[@class="credits_list"]/h3/text()'</span>).getall().index(<span class="st">'Acting'</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select the element corresponding to 'Acting' and its associated table</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        acting_only <span class="op">=</span> response.xpath(<span class="ss">f'(//div[@class="credits_list"]/table[@class="card credits"])[</span><span class="sc">{</span>acting_index <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">]'</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract movie or TV names from the selected table</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        movie_or_TV_name <span class="op">=</span> acting_only.xpath(<span class="st">'.//a[@class="tooltip"]/bdi/text()'</span>).getall()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> movie_or_TV_name <span class="kw">in</span> movie_or_TV_name:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> {</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"actor"</span>:actor_name,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"movie_or_TV_name"</span>: movie_or_TV_name</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This part was a bit tricky as we want to make sure that we only select movies and TV shows in which the person’s page that we are personing were credited in an acting role, as some also have production and other credits that we do not want included in the list.</p>
<p>In order to do this we must take advantage of the indexing in source code that will allow us to select only the acting roles. After looking an the source code on the page, we can see that all the acting roles for an actor had a line in common before listing all acting roles:</p>
<p>&lt;h3 class=“zero”&gt;Acting&lt;&gt;<br>
</p>
<p>Therefore we can use the follwoing xpath response to find the index for each actor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>response.xpath(<span class="st">'//div[@class="credits_list"]/h3/text()'</span>).getall().index(<span class="st">'Acting'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will store this index under the variable name actor_index.</p>
<p>Next we must use this variable to find the table on the actors page that corresponds to the acting index. Thus we can use the following to return this section of the table under the acting index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>response.xpath(<span class="ss">f'(//div[@class="credits_list"]/table[@class="card credits"])[</span><span class="sc">{</span>acting_index <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">]'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The reason we must add the +1 to acting_index is that xpath starts its index at 1 instead of 0. Therefore we must account for this change by adding the one.</p>
<p>The final stage of our extraction is to go through the table we selected and retrieve the title of each movie or TV show that the actor appears in.</p>
<p>Using the inspect element tool again, we can see that information is located under the &lt;a class = “tooltip”&gt;&nbsp;section, with the text of the film being wrapped by the &lt;bdi&gt;&nbsp;markers.</p>
<p>Therefore, we can use the followig line to get all the titles of the films and shows, as we are already under the acting table of the page. Therefore movie_or_TV_name will be a list of the credits for each actor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>acting_only.xpath(<span class="st">'.//a[@class="tooltip"]/bdi/text()'</span>).getall()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we yield the actors name and the credited film or TV show under the names “actor” and “movie_or_TV_show”, so when we export to a CSV file they will be the name of our columns.</p>
<p>Now that we have completed our spider class, we can run our code and output to a CSV file called output. Therefore we must run the following line in our terminal.</p>
<p>scrapy crawl tmdb_spider -o output.csv -a subdir=157336-interstellar</p>
<p>This will create an output called output.csv, we can read this file into a Pandas dataframe to view our data.</p>
</section>
<section id="first-data-analysis-number-of-shared-actors" class="level2">
<h2 class="anchored" data-anchor-id="first-data-analysis-number-of-shared-actors">First Data Analysis: Number of Shared Actors</h2>
<p>Now that we have our output we can convert the csv file into a Pandas dataframe to view and analyze our data. In a seperate file we can import Pandas and run the following line of code:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"output.csv"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 2063 entries, 0 to 2062
Data columns (total 2 columns):
 #   Column            Non-Null Count  Dtype 
---  ------            --------------  ----- 
 0   actor             2063 non-null   object
 1   movie_or_TV_name  2063 non-null   object
dtypes: object(2)
memory usage: 32.4+ KB</code></pre>
</div>
</div>
<p>As we can see we have 2063 rows of movie and TV show titles, with the columns actor and movie_or_TV_name.</p>
<p>Here is a what our data table would look like:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">actor</th>
<th data-quarto-table-cell-role="th">movie_or_TV_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Matthew McConaughey</td>
<td>2024</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Matthew McConaughey</td>
<td>The Lost Bus</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Matthew McConaughey</td>
<td>The Rivals of Amziah King</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Matthew McConaughey</td>
<td>Agent Elvis</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Matthew McConaughey</td>
<td>The Jennifer Hudson Show</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Matthew McConaughey</td>
<td>Deep in the Heart: A Texas Wildlife Story</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Matthew McConaughey</td>
<td>Sing 2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Matthew McConaughey</td>
<td>Come Home</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Matthew McConaughey</td>
<td>05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Matthew McConaughey</td>
<td>Roll Up Your Sleeves</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see that Matthew McConaughey is the first actor in our list and we can see his associated roles, for example “The Lost Bus” and “Come Home” are a couple of his roles.</p>
<p>Next we can see compute a sorted list with the top movies and TV shows that share actors from the movie Interstellar.</p>
<p>First we need to count the data by the tile of the role:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>counted <span class="op">=</span> df[<span class="st">"movie_or_TV_name"</span>].value_counts()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>counted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>movie_or_TV_name
Interstellar                   35
Saturday Night Live            10
The View                        9
Late Night with Seth Meyers     9
Inside 'Interstellar'           8
                               ..
Mayo                            1
As You Like It                  1
Born Equal                      1
Five Days                       1
Three Below Zero                1
Name: count, Length: 1754, dtype: int64</code></pre>
</div>
</div>
<p>As we can see the movie that we based our web crawler on appears first, so we should drop that from the list.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>counted <span class="op">=</span> counted.drop(counted.index[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, in order to for us to work with this data easier we must convert the Pandas series into a Pandas Data Frame and reset the index.</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>counted <span class="op">=</span> counted.to_frame()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>counted.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will also renmae the columns to Movie or Show Title and Number of Shared Actors.</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>counted <span class="op">=</span> counted.rename(columns<span class="op">=</span>{<span class="st">"movie_or_TV_name"</span>:<span class="st">"Movie or Show Title"</span>, <span class="st">"count"</span>:<span class="st">"Number of Shared Actors"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thus our new dataframe looks like the following:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>counted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Movie or Show Title</th>
<th data-quarto-table-cell-role="th">Number of Shared Actors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Saturday Night Live</td>
<td>10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>The View</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Late Night with Seth Meyers</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Inside 'Interstellar'</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>The Tonight Show Starring Jimmy Fallon</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1748</td>
<td>Mayo</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1749</td>
<td>As You Like It</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1750</td>
<td>Born Equal</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1751</td>
<td>Five Days</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1752</td>
<td>Three Below Zero</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>1753 rows × 2 columns</p>
</div>
</div>
</div>
<p>Now we can use plotly to create a bar graph of the some of the most common shared movies or TV shows among the actors in Interstellar. Since there are 1753 movies or TV shows, we will only pick the top 15 titles to display.</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.io <span class="im">as</span> pio</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>pio.renderers.default <span class="op">=</span> <span class="st">'iframe'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>top_counted <span class="op">=</span> counted.head(<span class="dv">15</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar chart using Plotly</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.bar(top_counted, x<span class="op">=</span><span class="st">'Movie or Show Title'</span>, y<span class="op">=</span><span class="st">'Number of Shared Actors'</span>, title<span class="op">=</span><span class="st">'Number of Shared Actors per Movie or Show'</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_37.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>As we can see, the top shared movies and shows are displayed in an interactive bar graph format, where if we hover over the bar we can exactly how many shared actors there are. The results are somewhat expected as well. We can see a majority of the shared titles are from late night shows or talk shows. This makes sense, as actors and celebrities often appear on these shows. Since Interstellar has a good amount of famous actors that would appear on these shows, the top results are something that we expect.</p>
<p>Other top shared roles are Inside “Interstellar”, which is a documentary on how the film was made, so it would make sense that a lot of the actors from Interstellar would appear in the documentary.</p>
<p>Another film of note is The Dark Knight Rises. This film, along with Interstellar, was directed by Christopher Nolan, and he is know for using some of the same actors in his films. Therefore it is not suprising to see one of his films on this list.</p>
</section>
<section id="second-data-analysis-number-of-roles-per-actor" class="level2">
<h2 class="anchored" data-anchor-id="second-data-analysis-number-of-roles-per-actor">Second Data Analysis: Number of Roles per Actor</h2>
<p>For our second data analysis, we can find the number of roles that each actor has been in and then display a bar graph to visualize the data.</p>
<p>We will count the number of roles and then sort by highest of number of roles. We will use plotly again to produce the graph.</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count number of roles and sort by highest number</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>roles_count <span class="op">=</span> df.groupby(<span class="st">'actor'</span>).size().reset_index(name<span class="op">=</span><span class="st">'Number of Roles'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>roles_count <span class="op">=</span> roles_count.sort_values(by<span class="op">=</span><span class="st">'Number of Roles'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar chart using Plotly</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.bar(roles_count, x<span class="op">=</span><span class="st">'actor'</span>, y<span class="op">=</span><span class="st">'Number of Roles'</span>, title<span class="op">=</span><span class="st">'Number of Roles for Each Actor'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_40.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>We can see that the interactive bar graph is displayed. The results are also what we expected. The actor with (by far) the highest number of roles is Michael Caine, with 224 roles. This is not suprising as Michael Caine is one of the oldest actors and has had a very long career in the film industry.</p>
<p>We can also see Matt Damon, Matthew McConaughey, and Anne Hathaway have the fourth, fifth, and sixth top roles. These are famous contemporary actors who have appeared in many famous films as well as have had very successfull careers. Therefore it is not suprising to see them near the top of the list.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Thank you for reading my blog post! I hope that you were able to learn more about web scrapping as well as how to display scrapped data.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>